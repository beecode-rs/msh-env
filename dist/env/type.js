import DeepEqual from 'fast-deep-equal/es6/index.js';
import { logger } from '#src/util/logger';
export class EnvType {
    _defaultValue = undefined;
    _convertStrategy;
    _env;
    _allowedValues = [];
    constructor(params) {
        const { convertStrategy, env } = params;
        this._convertStrategy = convertStrategy;
        this._env = env;
    }
    default(defaultValue) {
        this._loggerDebug('set default value', { defaultValue });
        this._defaultValue = defaultValue;
        return this;
    }
    get optional() {
        this._loggerDebug(`optional`);
        const strOrUndefined = this._env.envValue();
        this._loggerDebug(`try to convert env string value "${strOrUndefined}"`);
        const convertedValue = this._convertStrategy.convert(strOrUndefined);
        if (convertedValue === undefined) {
            this._loggerDebug(`using default value "${this._defaultValue}"`);
        }
        const optionalValue = convertedValue ?? this._defaultValue;
        this._validateAllowedValues(optionalValue);
        return optionalValue;
    }
    get required() {
        this._loggerDebug(`is required`);
        const envValue = this.optional;
        if (envValue === undefined) {
            throw this._createError('must have value defined');
        }
        return envValue;
    }
    allowed(...args) {
        this._loggerDebug(`set allowed values`, { allowedValues: args });
        this._allowedValues = [...args];
        return this;
    }
    _validateAllowedValues(value) {
        if (this._allowedValues.length === 0) {
            return;
        }
        this._loggerDebug('validating allowed values for:', { value });
        if (this._allowedValuesDoNotContain(value)) {
            throw this._createError(`must have one of the fallowing values: ${this._allowedValuesToString()}`);
        }
    }
    _allowedValuesDoNotContain(value) {
        const foundIndex = this._allowedValues.findIndex((v) => {
            return DeepEqual(value, v);
        });
        return foundIndex === -1;
    }
    _allowedValuesToString() {
        return this._allowedValues.map((v) => JSON.stringify(v)).join(', ');
    }
    _loggerDebug(msg, ...args) {
        logger().debug(`${this._envName} ${msg}`, ...args);
    }
    _createError(msg) {
        return new Error(`${this._envName} ${msg}`);
    }
    get _envName() {
        return `Env[${this._env.names.join(',')}]`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lbnYvdHlwZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLFNBQVMsTUFBTSw4QkFBOEIsQ0FBQTtBQUlwRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFFekMsTUFBTSxPQUFPLE9BQU87SUFDVCxhQUFhLEdBQWtCLFNBQVMsQ0FBQTtJQUMvQixnQkFBZ0IsQ0FBb0I7SUFDcEMsSUFBSSxDQUFLO0lBQ2xCLGNBQWMsR0FBUSxFQUFFLENBQUE7SUFFbEMsWUFBWSxNQUF5RDtRQUNwRSxNQUFNLEVBQUUsZUFBZSxFQUFFLEdBQUcsRUFBRSxHQUFHLE1BQU0sQ0FBQTtRQUN2QyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsZUFBZSxDQUFBO1FBQ3ZDLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFBO0lBQ2hCLENBQUM7SUFFRCxPQUFPLENBQUMsWUFBZTtRQUN0QixJQUFJLENBQUMsWUFBWSxDQUFDLG1CQUFtQixFQUFFLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQTtRQUN4RCxJQUFJLENBQUMsYUFBYSxHQUFHLFlBQVksQ0FBQTtRQUVqQyxPQUFPLElBQUksQ0FBQTtJQUNaLENBQUM7SUFFRCxJQUFJLFFBQVE7UUFDWCxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFBO1FBQzdCLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUE7UUFFM0MsSUFBSSxDQUFDLFlBQVksQ0FBQyxvQ0FBb0MsY0FBYyxHQUFHLENBQUMsQ0FBQTtRQUN4RSxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFBO1FBRXBFLElBQUksY0FBYyxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQ2xDLElBQUksQ0FBQyxZQUFZLENBQUMsd0JBQXdCLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFBO1FBQ2pFLENBQUM7UUFDRCxNQUFNLGFBQWEsR0FBRyxjQUFjLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQTtRQUUxRCxJQUFJLENBQUMsc0JBQXNCLENBQUMsYUFBYSxDQUFDLENBQUE7UUFFMUMsT0FBTyxhQUFhLENBQUE7SUFDckIsQ0FBQztJQUVELElBQUksUUFBUTtRQUNYLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLENBQUE7UUFFaEMsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQTtRQUM5QixJQUFJLFFBQVEsS0FBSyxTQUFTLEVBQUUsQ0FBQztZQUM1QixNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMseUJBQXlCLENBQUMsQ0FBQTtRQUNuRCxDQUFDO1FBRUQsT0FBTyxRQUFRLENBQUE7SUFDaEIsQ0FBQztJQUVELE9BQU8sQ0FBQyxHQUFHLElBQVM7UUFDbkIsSUFBSSxDQUFDLFlBQVksQ0FBQyxvQkFBb0IsRUFBRSxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFBO1FBQ2hFLElBQUksQ0FBQyxjQUFjLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFBO1FBRS9CLE9BQU8sSUFBSSxDQUFBO0lBQ1osQ0FBQztJQUVTLHNCQUFzQixDQUFDLEtBQVM7UUFDekMsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUN0QyxPQUFNO1FBQ1AsQ0FBQztRQUNELElBQUksQ0FBQyxZQUFZLENBQUMsZ0NBQWdDLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFBO1FBRTlELElBQUksSUFBSSxDQUFDLDBCQUEwQixDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDNUMsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLDBDQUEwQyxJQUFJLENBQUMsc0JBQXNCLEVBQUUsRUFBRSxDQUFDLENBQUE7UUFDbkcsQ0FBQztJQUNGLENBQUM7SUFFUywwQkFBMEIsQ0FBQyxLQUFTO1FBQzdDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7WUFDdEQsT0FBTyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFBO1FBQzNCLENBQUMsQ0FBQyxDQUFBO1FBRUYsT0FBTyxVQUFVLEtBQUssQ0FBQyxDQUFDLENBQUE7SUFDekIsQ0FBQztJQUVTLHNCQUFzQjtRQUMvQixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ3BFLENBQUM7SUFFUyxZQUFZLENBQUMsR0FBVyxFQUFFLEdBQUcsSUFBMkI7UUFDakUsTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsSUFBSSxHQUFHLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFBO0lBQ25ELENBQUM7SUFFUyxZQUFZLENBQUMsR0FBVztRQUNqQyxPQUFPLElBQUksS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsSUFBSSxHQUFHLEVBQUUsQ0FBQyxDQUFBO0lBQzVDLENBQUM7SUFFRCxJQUFjLFFBQVE7UUFDckIsT0FBTyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFBO0lBQzNDLENBQUM7Q0FDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBEZWVwRXF1YWwgZnJvbSAnZmFzdC1kZWVwLWVxdWFsL2VzNi9pbmRleC5qcydcblxuaW1wb3J0IHsgQ29udmVydFN0cmF0ZWd5IH0gZnJvbSAnI3NyYy9jb252ZXJ0LXN0cmF0ZWd5J1xuaW1wb3J0IHsgRW52IH0gZnJvbSAnI3NyYy9lbnYnXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcjc3JjL3V0aWwvbG9nZ2VyJ1xuXG5leHBvcnQgY2xhc3MgRW52VHlwZTxUPiB7XG5cdHByb3RlY3RlZCBfZGVmYXVsdFZhbHVlOiBUIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkXG5cdHByb3RlY3RlZCByZWFkb25seSBfY29udmVydFN0cmF0ZWd5OiBDb252ZXJ0U3RyYXRlZ3k8VD5cblx0cHJvdGVjdGVkIHJlYWRvbmx5IF9lbnY6IEVudlxuXHRwcm90ZWN0ZWQgX2FsbG93ZWRWYWx1ZXM6IFRbXSA9IFtdXG5cblx0Y29uc3RydWN0b3IocGFyYW1zOiB7IGNvbnZlcnRTdHJhdGVneTogQ29udmVydFN0cmF0ZWd5PFQ+OyBlbnY6IEVudiB9KSB7XG5cdFx0Y29uc3QgeyBjb252ZXJ0U3RyYXRlZ3ksIGVudiB9ID0gcGFyYW1zXG5cdFx0dGhpcy5fY29udmVydFN0cmF0ZWd5ID0gY29udmVydFN0cmF0ZWd5XG5cdFx0dGhpcy5fZW52ID0gZW52XG5cdH1cblxuXHRkZWZhdWx0KGRlZmF1bHRWYWx1ZTogVCk6IHRoaXMge1xuXHRcdHRoaXMuX2xvZ2dlckRlYnVnKCdzZXQgZGVmYXVsdCB2YWx1ZScsIHsgZGVmYXVsdFZhbHVlIH0pXG5cdFx0dGhpcy5fZGVmYXVsdFZhbHVlID0gZGVmYXVsdFZhbHVlXG5cblx0XHRyZXR1cm4gdGhpc1xuXHR9XG5cblx0Z2V0IG9wdGlvbmFsKCk6IFQgfCB1bmRlZmluZWQge1xuXHRcdHRoaXMuX2xvZ2dlckRlYnVnKGBvcHRpb25hbGApXG5cdFx0Y29uc3Qgc3RyT3JVbmRlZmluZWQgPSB0aGlzLl9lbnYuZW52VmFsdWUoKVxuXG5cdFx0dGhpcy5fbG9nZ2VyRGVidWcoYHRyeSB0byBjb252ZXJ0IGVudiBzdHJpbmcgdmFsdWUgXCIke3N0ck9yVW5kZWZpbmVkfVwiYClcblx0XHRjb25zdCBjb252ZXJ0ZWRWYWx1ZSA9IHRoaXMuX2NvbnZlcnRTdHJhdGVneS5jb252ZXJ0KHN0ck9yVW5kZWZpbmVkKVxuXG5cdFx0aWYgKGNvbnZlcnRlZFZhbHVlID09PSB1bmRlZmluZWQpIHtcblx0XHRcdHRoaXMuX2xvZ2dlckRlYnVnKGB1c2luZyBkZWZhdWx0IHZhbHVlIFwiJHt0aGlzLl9kZWZhdWx0VmFsdWV9XCJgKVxuXHRcdH1cblx0XHRjb25zdCBvcHRpb25hbFZhbHVlID0gY29udmVydGVkVmFsdWUgPz8gdGhpcy5fZGVmYXVsdFZhbHVlXG5cblx0XHR0aGlzLl92YWxpZGF0ZUFsbG93ZWRWYWx1ZXMob3B0aW9uYWxWYWx1ZSlcblxuXHRcdHJldHVybiBvcHRpb25hbFZhbHVlXG5cdH1cblxuXHRnZXQgcmVxdWlyZWQoKTogVCB7XG5cdFx0dGhpcy5fbG9nZ2VyRGVidWcoYGlzIHJlcXVpcmVkYClcblxuXHRcdGNvbnN0IGVudlZhbHVlID0gdGhpcy5vcHRpb25hbFxuXHRcdGlmIChlbnZWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG5cdFx0XHR0aHJvdyB0aGlzLl9jcmVhdGVFcnJvcignbXVzdCBoYXZlIHZhbHVlIGRlZmluZWQnKVxuXHRcdH1cblxuXHRcdHJldHVybiBlbnZWYWx1ZVxuXHR9XG5cblx0YWxsb3dlZCguLi5hcmdzOiBUW10pOiB0aGlzIHtcblx0XHR0aGlzLl9sb2dnZXJEZWJ1Zyhgc2V0IGFsbG93ZWQgdmFsdWVzYCwgeyBhbGxvd2VkVmFsdWVzOiBhcmdzIH0pXG5cdFx0dGhpcy5fYWxsb3dlZFZhbHVlcyA9IFsuLi5hcmdzXVxuXG5cdFx0cmV0dXJuIHRoaXNcblx0fVxuXG5cdHByb3RlY3RlZCBfdmFsaWRhdGVBbGxvd2VkVmFsdWVzKHZhbHVlPzogVCk6IHZvaWQge1xuXHRcdGlmICh0aGlzLl9hbGxvd2VkVmFsdWVzLmxlbmd0aCA9PT0gMCkge1xuXHRcdFx0cmV0dXJuXG5cdFx0fVxuXHRcdHRoaXMuX2xvZ2dlckRlYnVnKCd2YWxpZGF0aW5nIGFsbG93ZWQgdmFsdWVzIGZvcjonLCB7IHZhbHVlIH0pXG5cblx0XHRpZiAodGhpcy5fYWxsb3dlZFZhbHVlc0RvTm90Q29udGFpbih2YWx1ZSkpIHtcblx0XHRcdHRocm93IHRoaXMuX2NyZWF0ZUVycm9yKGBtdXN0IGhhdmUgb25lIG9mIHRoZSBmYWxsb3dpbmcgdmFsdWVzOiAke3RoaXMuX2FsbG93ZWRWYWx1ZXNUb1N0cmluZygpfWApXG5cdFx0fVxuXHR9XG5cblx0cHJvdGVjdGVkIF9hbGxvd2VkVmFsdWVzRG9Ob3RDb250YWluKHZhbHVlPzogVCk6IGJvb2xlYW4ge1xuXHRcdGNvbnN0IGZvdW5kSW5kZXggPSB0aGlzLl9hbGxvd2VkVmFsdWVzLmZpbmRJbmRleCgodikgPT4ge1xuXHRcdFx0cmV0dXJuIERlZXBFcXVhbCh2YWx1ZSwgdilcblx0XHR9KVxuXG5cdFx0cmV0dXJuIGZvdW5kSW5kZXggPT09IC0xXG5cdH1cblxuXHRwcm90ZWN0ZWQgX2FsbG93ZWRWYWx1ZXNUb1N0cmluZygpOiBzdHJpbmcge1xuXHRcdHJldHVybiB0aGlzLl9hbGxvd2VkVmFsdWVzLm1hcCgodikgPT4gSlNPTi5zdHJpbmdpZnkodikpLmpvaW4oJywgJylcblx0fVxuXG5cdHByb3RlY3RlZCBfbG9nZ2VyRGVidWcobXNnOiBzdHJpbmcsIC4uLmFyZ3M6IFJlY29yZDxzdHJpbmcsIGFueT5bXSk6IHZvaWQge1xuXHRcdGxvZ2dlcigpLmRlYnVnKGAke3RoaXMuX2Vudk5hbWV9ICR7bXNnfWAsIC4uLmFyZ3MpXG5cdH1cblxuXHRwcm90ZWN0ZWQgX2NyZWF0ZUVycm9yKG1zZzogc3RyaW5nKTogRXJyb3Ige1xuXHRcdHJldHVybiBuZXcgRXJyb3IoYCR7dGhpcy5fZW52TmFtZX0gJHttc2d9YClcblx0fVxuXG5cdHByb3RlY3RlZCBnZXQgX2Vudk5hbWUoKTogc3RyaW5nIHtcblx0XHRyZXR1cm4gYEVudlske3RoaXMuX2Vudi5uYW1lcy5qb2luKCcsJyl9XWBcblx0fVxufVxuIl19